apiVersion: kro.run/v1alpha1
kind: ResourceGroup
metadata:
  name: ec2controller.kro.run
  namespace: kro
spec:
  schema:
    apiVersion: v1alpha1
    kind: EC2Controller
    spec:
      name: string | default=ec2-controller
      namespace: string | default=default
      values:
        aws:
          accountID: string | required=true
          region: string | default=us-west-2
        deployment:
          containerPort: integer | default=8080
          replicas: integer | default=1
        iamRole:
          maxSessionDuration: integer | default=3600
          oidcProvider: string | required=true
          roleDescription: string | default=IRSA role for ACK EC2 controller deployement on EKS cluster using kro Resource group
        image:
          deletePolicy: string | default=delete
          repository: string | default=public.ecr.aws/aws-controllers-k8s/ec2-controller
          tag: string | default=1.2.27
          resources:
            requests:
              memory: string | default=64Mi
              cpu: string | default=50m
            limits:
              memory: string | default=128Mi
              cpu: string | default=100m
        log:
          enabled: boolean | default=false
          level: string | default=info
        serviceAccount:
          name: string | default=ec2-controller-sa
  resources:
  - id: ec2CRDGroup
    template:
      apiVersion: kro.run/v1alpha1
      kind: EC2CRDGroup
      metadata:
        name: ${schema.spec.name}-crd-group
      spec:
        name: ${schema.spec.name}-crd-group
  - id: ec2ControllerIamRole
    template:
      apiVersion: iam.services.k8s.aws/v1alpha1
      kind: Role
      metadata:
        name: ${schema.spec.name}-iam-role
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}-iam-role
        description: ${schema.spec.values.iamRole.roleDescription}
        maxSessionDuration: ${schema.spec.values.iamRole.maxSessionDuration}
        policies:
        - arn:aws:iam::aws:policy/AmazonEC2FullAccess
        assumeRolePolicyDocument: >
          {
            "Version": "2012-10-17",
            "Statement": [{
              "Effect": "Allow",
              "Principal": {"Federated": "arn:aws:iam::${schema.spec.values.aws.accountID}:oidc-provider/${schema.spec.values.iamRole.oidcProvider}"},
              "Action": "sts:AssumeRoleWithWebIdentity",
              "Condition": {
                  "StringEquals": {"${schema.spec.values.iamRole.oidcProvider}:sub": "system:serviceaccount:${schema.spec.namespace}:${schema.spec.values.serviceAccount.name}"}
              }
            }]
          }
  - id: serviceAccount
    template:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: ${schema.spec.values.serviceAccount.name}
        namespace: ${schema.spec.namespace}
        annotations:
          eks.amazonaws.com/role-arn: ${ec2ControllerIamRole.status.ackResourceMetadata.arn}
  - id: deployment
    template:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: ${schema.spec.name}-deployment
        namespace: ${schema.spec.namespace}
        labels:
          app.kubernetes.io.name: ${schema.spec.name}-deployment
          app.kubernetes.io.instance: ${schema.spec.name}
      spec:
        replicas: ${schema.spec.values.deployment.replicas}
        selector:
          matchLabels:
            app.kubernetes.io.name: ${schema.spec.name}-deployment
            app.kubernetes.io.instance: ${schema.spec.name}
        template:
          metadata:
            labels:
              app.kubernetes.io.name: ${schema.spec.name}-deployment
              app.kubernetes.io.instance: ${schema.spec.name}
          spec:
            serviceAccountName: ${serviceAccount.metadata.name}
            containers:
            - command:
              - ./bin/controller
              args:
              - --aws-region
              - ${schema.spec.values.aws.region}
              - --enable-development-logging=${schema.spec.values.log.enabled}
              - --log-level
              - ${schema.spec.values.log.level}
              - --deletion-policy
              - ${schema.spec.values.image.deletePolicy}
              - --watch-namespace
              - ${schema.spec.namespace}
              image: ${schema.spec.values.image.repository}:${schema.spec.values.image.tag}
              name: controller
              ports:
                - name: http
                  containerPort: ${schema.spec.values.deployment.containerPort}
              resources:
                requests:
                  memory: ${schema.spec.values.image.resources.requests.memory}
                  cpu: ${schema.spec.values.image.resources.requests.cpu}
                limits:
                    memory: ${schema.spec.values.image.resources.limits.memory}
                    cpu: ${schema.spec.values.image.resources.limits.cpu}
              env:
              - name: ACK_SYSTEM_NAMESPACE
                value: ${schema.spec.namespace}
              - name: AWS_REGION
                value: ${schema.spec.values.aws.region}
              - name: DELETE_POLICY
                value: ${schema.spec.values.image.deletePolicy}
              - name: ACK_LOG_LEVEL
                value: ${schema.spec.values.log.level}              
  - id: clusterRoleBinding
    template:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: ${schema.spec.name}-clusterrolebinding
      roleRef:
        kind: ClusterRole
        apiGroup: rbac.authorization.k8s.io
        name: ${clusterRole.metadata.name}
      subjects:
      - kind: ServiceAccount
        name: ${serviceAccount.metadata.name}
        namespace: ${serviceAccount.metadata.namespace}
  - id: clusterRole
    template:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRole
      metadata:
        name: ${schema.spec.name}-clusterrole
      rules:
      - apiGroups:
        - ""
        resources:
        - configmaps
        verbs:
        - get
        - list
        - patch
        - watch
      - apiGroups:
        - ""
        resources:
        - namespaces
        verbs:
        - get
        - list
        - watch
      - apiGroups:
        - ""
        resources:
        - secrets
        verbs:
        - get
        - list
        - patch
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - dhcpoptions
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - dhcpoptions/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - elasticipaddresses
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - elasticipaddresses/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - flowlogs
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - flowlogs/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - instances
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - instances/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - internetgateways
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - internetgateways/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - natgateways
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - natgateways/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - networkacls
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - networkacls/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - routetables
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - routetables/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - securitygroups
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - securitygroups/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - subnets
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - subnets/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - transitgateways
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - transitgateways/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - vpcendpoints
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - vpcendpoints/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - vpcendpointserviceconfigurations
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - vpcendpointserviceconfigurations/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - vpcpeeringconnections
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - vpcpeeringconnections/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - vpcs
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - ec2.services.k8s.aws
        resources:
        - vpcs/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - services.k8s.aws
        resources:
        - adoptedresources
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - services.k8s.aws
        resources:
        - adoptedresources/status
        verbs:
        - get
        - patch
        - update
      - apiGroups:
        - services.k8s.aws
        resources:
        - fieldexports
        verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
      - apiGroups:
        - services.k8s.aws
        resources:
        - fieldexports/status
        verbs:
        - get
        - patch
        - update
